---
title: "Cox Proportional Hazards Model"
subtitle: "Intervire of GRAIL in Feb 2025"
author: "Yuhui Cao"
date: "2025.02.26 Wed"
output: pdf_document
---


# Key Assumptions
## a. Proportional hazards assumption: 
 - The effect of covariates does not change over time.
 - The ratio of hazards for any two individuals remains constant over time.
 
## b. Independent censoring: Censoring (loss of follow-up) should not be related to the likelihood of an event occurring.



```{r}
library(survival)
```

# 0.1 my updated data - significant in Log-Rank Test + to fit Cox Proportional Hazards Model
```{r}
data <- data.frame(
  time      = c(5, 8, 12, 22, 40,    12, 20, 30, 35, 38, 40),
  status    = c(1, 1, 1,  1,  1,     1,  1,  1,  0,  0,  0),  # 1 = Event, 0 = Censored
  treatment = c(0, 0, 0,  0,  0,     1,  1,  1,  1,  1,  1),  # 0 = Control, 1 = Treatment
  # add age variable - to fit Cox Proportional Hazards Model
  age       = c(70,65,50, 40, 42,    72, 64, 55, 50, 30, 40)
)

data
```

# 0.2 fit the model
```{r}
# Fit Cox Proportional Hazards Model
cox_model <- coxph(Surv(time, status) ~ age + treatment, data = data)

# Display the model summary
summary(cox_model)
```


# Interpretation of Cox Proportional Hazards Model (1):
## exp(coef) gives the hazard ratio (HR) for each covariate.
 - **HR > 1** indicates **increased** risk, while 
 - **HR < 1** indicates **reduced** risk.


# Interpretation of Cox Proportional Hazards Model (2):
## a. coef (B or beta): Log hazard ratio. A positive value means an increased risk of event occurrence.
## b. exp(coef): Hazard ratio (HR). If HR > 1, the variable increases risk; if HR < 1, itâ€™s protective.
  - Example: exp(sex) = 0.59: Being male (coded 1) decreases the hazard by 41% compared to females (coded 0).
  
## c. p-value: Significance of the predictor. If p < 0.05, the variable significantly affects survival.







# 1. Model Diagnostics and Assumption Checking:
## 1.1 Proportional Hazards Assumption: 
Check if hazard ratios are constant over time.
```{r}
cox.zph(cox_model)
```
## Use Schoenfeld residuals to test this assumption:
## p-values > 0.05 suggest that the proportional hazards assumption holds.

```{r}
plot(cox.zph(cox_model))
```

## 1.2 Influence and Outlier Detection:
# Identify influential observations using dfbeta or deviance residuals:
```{r}
residuals(cox_model, type = "dfbeta")
```

```{r}
residuals(cox_model, type = "deviance")
```


# 2. Model Validation and Goodness of Fit:
## 2.1 Concordance Index (C-Index):
Measures the model's ability to correctly rank survival times:
```{r}
summary(cox_model)$concordance
```
A C-index closer to 1 indicates better predictive discrimination.

## 2.2 Likelihood Ratio Test and Wald Test:
Assess overall model significance and significance of individual covariates.
These are typically included in the model summary.


# 3. Visualization of Cox Model Results:
## 3.1 Hazard Ratios with Confidence Intervals:
**Forest plots** for H.R.s and C.I.s.
```{r}
library(survminer)
```

Function: **ggforest()**
```{r}
ggforest(cox_model, data = data, main = "Hazard Ratio for XXXX Survival")
```


## 3.2 Survival Curves: 
## - adjusted survival curves (not the best; see details in later RMD file)
Plot adjusted survival curves for different groups or covariate values:
```{r}
survfit(cox_model)
plot(survfit(cox_model), xlab = "Time", ylab = "Survival Probability")
```


# 4. Handling Violations of Assumptions:
## 4.1 If the proportional hazards assumption is violated:
Stratified Cox Model: Allow baseline hazards to vary across strata:
```{r}
coxph(Surv(time, status) ~ strata(sex) + age, data = lung)
```

## 4.2 Time-Dependent Covariates: Include interactions with time to model changing effects:
```{r}
coxph(Surv(time, status) ~ age + sex * tt(sex), data = lung,
      tt = function(x, t, ...) x * log(t))
```

# 5. Predictive Modeling and Risk Assessment:
## 5.1 Predicting Survival Probabilities:
```{r}
#predict(cox_model, newdata = new_patient, type = "survival")
```

## 5.2 Risk Scores and Stratification:
Calculate risk scores for patients and categorize them into risk groups.

# 6. Reporting and Interpretation:
Clearly report the hazard ratios, confidence intervals, and p-values.
Interpret the hazard ratios in the context of the research question.


















